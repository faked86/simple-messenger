<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ChatApp</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- linking css file with html file -->
    <link rel="stylesheet" href="{{ url_for('static', path='chat.css') }}">
</head>

<body>
    <div class="chat-body card">
        <div class="card-body">
            <strong id="profile"></strong>
            <h4 class="card-title text-center"> Chat App </h4>
            <hr>
            <div id="nickname-div">
                <h4 lass="card-title text-center">Your Nickname:</h4>
                <form action="" id="nickname-form" class="form-inline">
                    <input type="text" id="nickname-text" class="form-control" autocomplete="off" />
                    <button class="btn btn-primary">Set</button>
                </form>
            </div>
            <div id="box" hidden>
                <div id="premessages-div">
                    <div id="messages-div">
                    </div>
                    <form class="form-inline" id="chat-form">
                        <input type="text" id="chat-text" class="form-control" autocomplete="off"
                            placeholder="Write your message">
                        <button id="send" type="submit" class="btn btn-primary">Send</button>
                    </form>
                </div>
                <div id="chatters-div">
                    <h6 class="card-title text-center"> Chat Members: </h6>
                    <hr>
                    <ul id="chatters-list">
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    const client_id = Date.now();
    var nickname = "";
    var ws = new WebSocket(`ws://localhost:8000/ws/${client_id}`);

    var nicknameForm = document.getElementById('nickname-form');
    nicknameForm.addEventListener('submit', function (e) {
        e.preventDefault();
        e.stopPropagation();

        nickname = document.getElementById("nickname-text").value;
        if (nickname) {
            onStart();
        }
    });

    function onStart() {
        document.getElementById('nickname-div').hidden = true;
        document.getElementById('box').hidden = false;

        document.getElementById("profile").textContent = nickname;

        data = {
            "client_id": client_id,
            "nickname": nickname,
            "message": null,
            "picture": null
        };
        ws.send(JSON.stringify(data));

        var chatForm = document.getElementById("chat-form");
        chatForm.addEventListener('submit', sendMessage);
    };

    ws.onmessage = function (event) {
        console.log(event.data)

        var data = JSON.parse(event.data);
        var sender = data['nickname'];
        if (sender == nickname)
            sender = "You";
        var message = data['message'];

        renderNotification(sender + ":")
        renderText(message)
    };

    function sendMessage(event) {
        event.preventDefault()
        event.stopPropagation();

        var input = document.getElementById("chat-text")
        var message = input.value
        if (message) {
            input.value = ''
            data = {
                "client_id": client_id,
                "nickname": nickname,
                "message": message,
                "picture": null
            };
            console.log(data)
            ws.send(JSON.stringify(data))
        }
    };

    function renderNotification(text) {
        let messagesDiv = document.getElementById("messages-div");
        let notification = document.createElement('div');
        notification.className = 'notification';
        notification.innerText = text;
        messagesDiv.append(notification);
        messagesDiv.scrollTo(0, messagesDiv.scrollHeight);
    }

    function renderText(text) {
        let messagesDiv = document.getElementById("messages-div");
        let msg = document.createElement('div');
        msg.className = 'message';
        msg.innerText = text;
        messagesDiv.append(msg);
        messagesDiv.scrollTo(0, messagesDiv.scrollHeight);
    }

    function renderChatters(listOfChatters) {
        var list = document.getElementById("chatters-list");
        list.innerHTML = "";

        for (let i = 0; i < listOfChatters.length; i += 1) {
            let el = document.createElement('li');
            el.className = 'chatter';
            el.innerText = listOfChatters[i];
            list.append(el);
        }
    }
</script>

</html>